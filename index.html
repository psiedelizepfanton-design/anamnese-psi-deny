<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Cl√≠nico Pro - Psi Dra. Deny</title>
<style>
    :root {
        --primary: #1e3a8a; /* Azul Profissional */
        --secondary: #3b82f6;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --text: #1f2937;
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #10b981;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
        font-family: 'Segoe UI', Inter, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* TELA DE LOGIN */
    #loginScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--primary);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000;
    }
    .login-box {
        background: white; padding: 2rem; border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px;
    }
    .login-box h2 { color: var(--primary); margin-top: 0; }
    
    /* LAYOUT PRINCIPAL */
    header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0 20px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    header h1 { font-size: 1.2rem; color: var(--primary); margin: 0; }
    
    .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* SIDEBAR (LISTA DE PACIENTES) */
    aside {
        width: 300px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
    }
    .search-bar { padding: 15px; border-bottom: 1px solid var(--border); }
    .patient-list { 
        flex: 1; overflow-y: auto; 
    }
    .patient-item {
        padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
        transition: background 0.2s; display: flex; justify-content: space-between;
    }
    .patient-item:hover, .patient-item.active { background: #eff6ff; border-left: 4px solid var(--primary); }
    
    /* √ÅREA DE CONTE√öDO */
    main {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8fafc;
    }

    .card {
        background: white; border-radius: 8px; padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
    }

    /* FORMUL√ÅRIOS */
    input, textarea, select {
        width: 100%; padding: 10px; margin: 5px 0 15px 0;
        border: 1px solid var(--border); border-radius: 6px;
        font-family: inherit; font-size: 0.95rem;
    }
    input:focus, textarea:focus { border-color: var(--secondary); ring: 2px solid var(--secondary); }
    
    textarea { min-height: 100px; resize: vertical; }

    button {
        background: var(--primary); color: white; border: none;
        padding: 10px 20px; border-radius: 6px; cursor: pointer;
        font-weight: 600; transition: 0.2s;
    }
    button:hover { background: var(--secondary); }
    button.secondary { background: white; color: var(--text); border: 1px solid var(--border); }
    button.secondary:hover { background: #f3f4f6; }
    button.danger { background: var(--danger); }
    button.icon-btn { padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

    /* ABAS */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 20px; cursor: pointer; opacity: 0.6; border-bottom: 2px solid transparent; }
    .tab.active { opacity: 1; border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }

    /* TIMELINE DAS SESS√ïES */
    .timeline-item {
        border-left: 3px solid var(--primary);
        padding-left: 20px; margin-bottom: 20px; position: relative;
    }
    .timeline-item::before {
        content: ''; position: absolute; left: -8px; top: 0;
        width: 13px; height: 13px; background: var(--primary); border-radius: 50%;
    }
    .date-badge { 
        background: #e0e7ff; color: var(--primary); padding: 4px 8px; 
        border-radius: 4px; font-size: 0.85rem; font-weight: bold; display: inline-block; margin-bottom: 8px;
    }

    /* MODAL DE CONFIGURA√á√ÉO */
    .modal {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
    }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }

    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2>üîí √Årea Restrita</h2>
        <p>Psi. Dra. Deny</p>
        <input type="password" id="loginPass" placeholder="Digite sua senha de acesso">
        <button onclick="fazerLogin()">Entrar / Criar Senha</button>
        <p id="loginMsg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>PsiManager 2.0</h1>
    </div>
    <div style="display:flex; gap: 10px;">
        <button class="secondary" onclick="exportarDados()">üíæ Backup (Salvar)</button>
        <button class="secondary" onclick="triggerImport()">üìÇ Importar</button>
        <button class="icon-btn secondary" onclick="abrirConfig()">‚öôÔ∏è</button>
        <button class="icon-btn danger" onclick="logout()">üîí</button>
    </div>
</header>

<div class="main-container">
    <aside>
        <div class="search-bar">
            <input type="text" id="buscaInput" placeholder="üîç Buscar paciente..." onkeyup="filtrarPacientes()">
            <button onclick="adicionarPaciente()" style="width:100%">+ Novo Paciente</button>
        </div>
        <div class="patient-list" id="listaPacientes">
            </div>
    </aside>

    <main id="areaTrabalho">
        <div id="emptyState" style="text-align:center; padding-top:50px; color:#888;">
            <h2>Selecione ou crie um paciente</h2>
            <p>Os dados s√£o criptografados localmente.</p>
        </div>

        <div id="pacienteView" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="tituloPaciente" style="color:var(--primary)">Nome do Paciente</h2>
                <button class="secondary" style="font-size:0.8rem; padding:5px 10px;" onclick="excluirPaciente()">üóë Excluir</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="mudarAba('anamnese')">Anamnese</div>
                <div class="tab" onclick="mudarAba('sessoes')">Sess√µes Cl√≠nicas</div>
            </div>

            <div id="tabAnamnese">
                <div class="card">
                    <h3>Dados Cl√≠nicos</h3>
                    <div id="camposAnamnese">
                        </div>
                    <button onclick="salvarAnamneseAtual()">Salvar Altera√ß√µes</button>
                </div>
            </div>

            <div id="tabSessoes" class="hidden">
                <div class="card">
                    <h3>Nova Sess√£o</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="dataSessao" style="width:150px">
                    </div>
                    <textarea id="textoEvolucao" placeholder="Descreva a evolu√ß√£o, interven√ß√µes e plano terap√™utico..."></textarea>
                    <button onclick="adicionarSessao()">Registrar Sess√£o</button>
                </div>

                <div id="historicoSessoes">
                    </div>
            </div>
        </div>
    </main>
</div>

<div id="modalConfig" class="modal">
    <div class="modal-content">
        <h3>Configurar Campos da Anamnese</h3>
        <p>Defina os t√≠tulos dos campos (separados por v√≠rgula):</p>
        <textarea id="configCampos" style="height:100px"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="secondary" onclick="fecharConfig()">Cancelar</button>
            <button onclick="salvarConfig()">Salvar Configura√ß√£o</button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json,.txt" style="display:none" onchange="processarImportacao(this)">

<script>
// --- ESTADO DO SISTEMA ---
let ESTADO = {
    senha: null,
    pacientes: {},
    config: {
        campos: ["Queixa Principal", "Hist√≥rico", "Contexto Familiar", "Avalia√ß√£o Inicial", "Objetivos"]
    },
    pacienteAtual: null
};

// --- CRIPTOGRAFIA SIMPLES (XOR + Base64) ---
// Nota: Para um sistema local sem backend, isso previne leitura simples (olheiros).
function criptografar(texto, senha) {
    let resultado = "";
    for (let i = 0; i < texto.length; i++) {
        resultado += String.fromCharCode(texto.charCodeAt(i) ^ senha.charCodeAt(i % senha.length));
    }
    return btoa(resultado); // Converte para Base64
}

function descriptografar(textoCifrado, senha) {
    try {
        let texto = atob(textoCifrado); // Decodifica Base64
        let resultado = "";
        for (let i = 0; i < texto.length; i++) {
            resultado += String.fromCharCode(texto.charCodeAt(i) ^ senha.charCodeAt(i % senha.length));
        }
        return resultado;
    } catch (e) {
        return null; // Erro na senha ou dados corrompidos
    }
}

// --- SISTEMA DE ARQUIVOS E PERSIST√äNCIA ---
const DB_KEY = "PSI_DENY_DATA_V2";

function salvarNoDisco() {
    if(!ESTADO.senha) return;
    const dadosPuros = JSON.stringify({
        pacientes: ESTADO.pacientes,
        config: ESTADO.config
    });
    // Salva encriptado no LocalStorage
    localStorage.setItem(DB_KEY, criptografar(dadosPuros, ESTADO.senha));
}

function carregarDoDisco() {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) return false; // Primeiro acesso
    
    const jsonStr = descriptografar(raw, ESTADO.senha);
    if (!jsonStr) return "SENHA_INCORRETA";

    try {
        const dados = JSON.parse(jsonStr);
        ESTADO.pacientes = dados.pacientes || {};
        ESTADO.config = dados.config || ESTADO.config;
        return true;
    } catch (e) {
        return "ERRO_DADOS";
    }
}

// --- LOGICA DE LOGIN ---
function fazerLogin() {
    const pass = document.getElementById('loginPass').value;
    if (!pass) return;

    // Se j√° existe dados, tenta descriptografar
    if (localStorage.getItem(DB_KEY)) {
        ESTADO.senha = pass;
        const resultado = carregarDoDisco();
        if (resultado === true) {
            iniciarApp();
        } else if (resultado === "SENHA_INCORRETA") {
            document.getElementById('loginMsg').innerText = "Senha incorreta.";
            ESTADO.senha = null;
        } else {
            alert("Dados corrompidos ou erro fatal.");
        }
    } else {
        // Primeiro acesso, define a senha
        if (confirm("Esta ser√° sua senha Mestra para criptografar os dados. N√£o a esque√ßa! Confirmar?")) {
            ESTADO.senha = pass;
            salvarNoDisco();
            iniciarApp();
        }
    }
}

function logout() {
    ESTADO.senha = null;
    location.reload();
}

function iniciarApp() {
    document.getElementById('loginScreen').style.display = 'none';
    renderListaPacientes();
    atualizarCamposDinamicos();
}

// --- GEST√ÉO DE PACIENTES ---
function adicionarPaciente() {
    const nome = prompt("Nome do novo paciente:");
    if (!nome) return;
    if (ESTADO.pacientes[nome]) return alert("Paciente j√° existe!");

    // Estrutura do Paciente
    ESTADO.pacientes[nome] = {
        cadastro: new Date().toISOString(),
        anamnese: {}, // Campos din√¢micos entram aqui
        sessoes: []
    };
    
    salvarNoDisco();
    renderListaPacientes();
    abrirPaciente(nome);
}

function excluirPaciente() {
    if (!ESTADO.pacienteAtual) return;
    const confirmacao = prompt(`Para excluir ${ESTADO.pacienteAtual}, digite 'DELETAR':`);
    if (confirmacao === 'DELETAR') {
        delete ESTADO.pacientes[ESTADO.pacienteAtual];
        ESTADO.pacienteAtual = null;
        salvarNoDisco();
        renderListaPacientes();
        document.getElementById('pacienteView').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
    }
}

function renderListaPacientes() {
    const lista = document.getElementById('listaPacientes');
    const termo = document.getElementById('buscaInput').value.toLowerCase();
    lista.innerHTML = "";

    const nomes = Object.keys(ESTADO.pacientes).sort();
    
    nomes.forEach(nome => {
        if (nome.toLowerCase().includes(termo)) {
            const div = document.createElement('div');
            div.className = `patient-item ${ESTADO.pacienteAtual === nome ? 'active' : ''}`;
            div.innerText = nome;
            div.onclick = () => abrirPaciente(nome);
            lista.appendChild(div);
        }
    });
}

function filtrarPacientes() {
    renderListaPacientes();
}

function abrirPaciente(nome) {
    ESTADO.pacienteAtual = nome;
    document.getElementById('tituloPaciente').innerText = nome;
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('pacienteView').classList.remove('hidden');
    
    // Renderiza dados
    renderListaPacientes(); // Para atualizar o highlight
    preencherAnamnese();
    renderSessoes();
    mudarAba('anamnese'); // Reseta para primeira aba
}

// --- ANAMNESE E CAMPOS DIN√ÇMICOS ---
function atualizarCamposDinamicos() {
    const container = document.getElementById('camposAnamnese');
    container.innerHTML = "";
    ESTADO.config.campos.forEach(campo => {
        const label = document.createElement('label');
        label.innerText = campo;
        label.style.fontWeight = "bold";
        label.style.display = "block";
        label.style.marginTop = "10px";

        const area = document.createElement('textarea');
        area.dataset.campo = campo; // Marcador para salvar depois
        area.placeholder = `Digite informa√ß√µes sobre ${campo}...`;
        
        container.appendChild(label);
        container.appendChild(area);
    });
}

function preencherAnamnese() {
    const dados = ESTADO.pacientes[ESTADO.pacienteAtual].anamnese || {};
    const areas = document.querySelectorAll('#camposAnamnese textarea');
    areas.forEach(area => {
        const campoNome = area.dataset.campo;
        area.value = dados[campoNome] || "";
    });
}

function salvarAnamneseAtual() {
    if (!ESTADO.pacienteAtual) return;
    const areas = document.querySelectorAll('#camposAnamnese textarea');
    const novosDados = {};
    areas.forEach(area => {
        novosDados[area.dataset.campo] = area.value;
    });
    
    ESTADO.pacientes[ESTADO.pacienteAtual].anamnese = novosDados;
    salvarNoDisco();
    alert("Anamnese salva com sucesso! ‚úÖ");
}

// --- SESS√ïES CL√çNICAS ---
function adicionarSessao() {
    const data = document.getElementById('dataSessao').value;
    const texto = document.getElementById('textoEvolucao').value;
    
    if (!data || !texto) return alert("Preencha a data e a evolu√ß√£o.");

    ESTADO.pacientes[ESTADO.pacienteAtual].sessoes.push({
        id: Date.now(),
        data: data,
        texto: texto
    });

    // Ordena sess√µes por data (mais recente primeiro)
    ESTADO.pacientes[ESTADO.pacienteAtual].sessoes.sort((a,b) => new Date(b.data) - new Date(a.data));

    salvarNoDisco();
    document.getElementById('textoEvolucao').value = "";
    renderSessoes();
}

function renderSessoes() {
    const lista = ESTADO.pacientes[ESTADO.pacienteAtual].sessoes || [];
    const container = document.getElementById('historicoSessoes');
    container.innerHTML = "<h4>Hist√≥rico Cl√≠nico</h4>";

    if (lista.length === 0) {
        container.innerHTML += "<p style='color:#888'>Nenhuma sess√£o registrada.</p>";
        return;
    }

    lista.forEach(sessao => {
        const div = document.createElement('div');
        div.className = "timeline-item";
        
        // Formata data brasileira
        const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
        
        div.innerHTML = `
            <div class="date-badge">${dataFormatada}</div>
            <div style="white-space: pre-wrap;">${sessao.texto}</div>
        `;
        container.appendChild(div);
    });
}

// --- UI HELPERS ---
function mudarAba(aba) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#tabAnamnese, #tabSessoes').forEach(d => d.classList.add('hidden'));
    
    if (aba === 'anamnese') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('tabAnamnese').classList.remove('hidden');
    } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tabSessoes').classList.remove('hidden');
    }
}

// --- CONFIGURA√á√ïES ---
function abrirConfig() {
    document.getElementById('configCampos').value = ESTADO.config.campos.join(", ");
    document.getElementById('modalConfig').style.display = 'flex';
}

function fecharConfig() {
    document.getElementById('modalConfig').style.display = 'none';
}

function salvarConfig() {
    const texto = document.getElementById('configCampos').value;
    const array = texto.split(",").map(s => s.trim()).filter(s => s);
    if (array.length > 0) {
        ESTADO.config.campos = array;
        salvarNoDisco();
        atualizarCamposDinamicos();
        if (ESTADO.pacienteAtual) preencherAnamnese(); // Recarrega se tiver aberto
        fecharConfig();
        alert("Campos atualizados!");
    }
}

// --- IMPORTAR / EXPORTAR ---
function exportarDados() {
    if (!ESTADO.senha) return alert("Fa√ßa login primeiro.");
    
    // Gera arquivo JSON completo
    const dados = JSON.stringify({
        pacientes: ESTADO.pacientes,
        config: ESTADO.config
    }, null, 2);

    const blob = new Blob([dados], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Backup_Psi_Deny_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function triggerImport() {
    document.getElementById('fileInput').click();
}

function processarImportacao(input) {
    const arquivo = input.files[0];
    if (!arquivo) return;

    const leitor = new FileReader();
    leitor.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            if (json.pacientes && json.config) {
                if(confirm("Isso ir√° SUBSTITUIR os dados atuais pelos do arquivo. Confirma?")) {
                    ESTADO.pacientes = json.pacientes;
                    ESTADO.config = json.config;
                    salvarNoDisco();
                    iniciarApp();
                    alert("Importa√ß√£o realizada com sucesso! ‚úÖ");
                }
            } else {
                alert("Arquivo inv√°lido. Formato n√£o reconhecido.");
            }
        } catch (erro) {
            alert("Erro ao ler o arquivo. Verifique se √© um backup v√°lido.");
        }
    };
    leitor.readAsText(arquivo);
    input.value = ""; // Limpa para permitir re-sele√ß√£o
}

// Inicializa a data de hoje no input de sess√£o
document.getElementById('dataSessao').valueAsDate = new Date();

</script>
</body>
</html>
