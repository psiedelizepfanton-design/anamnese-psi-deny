<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Cl√≠nico Pro v3.0 ‚Äì Psi Dra. Deny</title>
<style>
    :root {
        --primary: #1e3a8a; /* Azul Profissional */
        --secondary: #3b82f6;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --text: #1f2937;
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
        font-family: 'Segoe UI', Inter, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* TELA DE LOGIN */
    #loginScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--primary);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000;
    }
    .login-box {
        background: white; padding: 2rem; border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px;
    }
    
    /* LAYOUT PRINCIPAL */
    header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0 20px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* SIDEBAR */
    aside {
        width: 320px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
    }
    .search-bar { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; }
    .patient-list { flex: 1; overflow-y: auto; }
    .patient-item {
        padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
        transition: background 0.2s;
    }
    .patient-item:hover, .patient-item.active { background: #eff6ff; border-left: 4px solid var(--primary); }
    .patient-item small { display: block; color: #666; margin-top: 4px; font-size: 0.8rem; }
    
    /* √ÅREA DE CONTE√öDO */
    main {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: #f8fafc;
    }

    .card {
        background: white; border-radius: 8px; padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
        border: 1px solid var(--border);
    }

    /* INPUTS E BOT√ïES */
    input, textarea, select {
        width: 100%; padding: 10px; margin: 5px 0 15px 0;
        border: 1px solid var(--border); border-radius: 6px;
        font-family: inherit; font-size: 0.95rem;
    }
    textarea { min-height: 100px; resize: vertical; }

    button {
        background: var(--primary); color: white; border: none;
        padding: 10px 20px; border-radius: 6px; cursor: pointer;
        font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    button:hover { background: var(--secondary); transform: translateY(-1px); }
    button.secondary { background: white; color: var(--text); border: 1px solid var(--border); }
    button.secondary:hover { background: #f3f4f6; }
    button.danger { background: var(--danger); color: white; }
    
    /* ABAS */
    .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 0; cursor: pointer; opacity: 0.6; border-bottom: 3px solid transparent; font-weight: 500; }
    .tab.active { opacity: 1; border-bottom-color: var(--primary); color: var(--primary); }

    /* INFO PESSOAL HEADER */
    .personal-info {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;
        background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;
    }
    .info-group label { font-size: 0.75rem; color: #64748b; font-weight: bold; text-transform: uppercase; }
    .info-group div { font-weight: 500; }

    /* MODAL */
    .modal {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
    }
    .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; }

    .tag-extra { background: #fff7ed; border: 1px solid #fed7aa; color: #c2410c; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; display: inline-block; }

    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin:0 0 10px 0;">PsiManager 3.0</h2>
        <p style="margin-bottom:20px; color:#666;">Acesso Exclusivo Dra. Deny</p>
        <input type="password" id="loginPass" placeholder="Senha Mestra">
        <button onclick="fazerLogin()" style="width:100%; justify-content:center;">Entrar</button>
        <p id="loginMsg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<header>
    <div style="font-weight:bold; font-size:1.2rem; color:var(--primary);">PsiManager <span style="font-weight:normal; font-size:0.9rem; color:#666;">v3.0</span></div>
    <div style="display:flex; gap: 10px;">
        <button class="secondary" onclick="exportarBackup()">üíæ Backup (JSON)</button>
        <button class="secondary" onclick="triggerImport('csv')">üìÑ Importar Planilha (CSV)</button>
        <button class="secondary" onclick="triggerImport('json')">üìÇ Restaurar Backup</button>
        <button class="secondary" onclick="abrirConfig()">‚öôÔ∏è</button>
        <button class="danger" onclick="logout()" style="padding: 10px;">üîí</button>
    </div>
</header>

<div class="main-container">
    <aside>
        <div class="search-bar">
            <input type="text" id="buscaInput" placeholder="Buscar paciente..." onkeyup="filtrarPacientes()" style="margin-bottom:10px;">
            <button onclick="adicionarPaciente()" style="width:100%; justify-content:center;">+ Novo Paciente</button>
        </div>
        <div class="patient-list" id="listaPacientes"></div>
    </aside>

    <main id="areaTrabalho">
        <div id="emptyState" style="text-align:center; padding-top:100px; color:#94a3b8;">
            <div style="font-size:3rem; margin-bottom:20px;">üë©‚Äç‚öïÔ∏è</div>
            <h2>Selecione um paciente</h2>
            <p>Seus dados est√£o protegidos com criptografia local.</p>
        </div>

        <div id="pacienteView" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 id="tituloPaciente" style="margin:0; color:var(--primary);">Nome</h1>
                <button class="secondary" onclick="excluirPaciente()" style="font-size:0.8rem; color:var(--danger); border-color:var(--danger);">Excluir Paciente</button>
            </div>

            <div class="personal-info">
                <div class="info-group">
                    <label>Data Nascimento</label>
                    <input type="date" id="infoNascimento" onchange="salvarDadosPessoais()">
                </div>
                <div class="info-group">
                    <label>Telefone</label>
                    <input type="text" id="infoTelefone" placeholder="(00) 00000-0000" onchange="salvarDadosPessoais()">
                </div>
                <div class="info-group">
                    <label>E-mail</label>
                    <input type="text" id="infoEmail" placeholder="email@exemplo.com" onchange="salvarDadosPessoais()">
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="mudarAba('anamnese')">Anamnese</div>
                <div class="tab" onclick="mudarAba('sessoes')">Sess√µes Cl√≠nicas</div>
            </div>

            <div id="tabAnamnese">
                <div class="card">
                    <h3 style="margin-top:0;">Anamnese Principal</h3>
                    <div id="camposAnamnese"></div>
                </div>

                <div id="containerExtras" class="card hidden">
                    <h3 style="margin-top:0; color:var(--warning);">Outras Informa√ß√µes (Importadas)</h3>
                    <p style="font-size:0.85rem; color:#666;">Estes campos vieram da planilha e n√£o est√£o na configura√ß√£o padr√£o.</p>
                    <div id="camposExtras"></div>
                </div>
                
                <button onclick="salvarAnamneseAtual()">Salvar Altera√ß√µes</button>
            </div>

            <div id="tabSessoes" class="hidden">
                <div class="card">
                    <h3 style="margin-top:0;">Nova Sess√£o</h3>
                    <input type="date" id="dataSessao" style="width:150px;">
                    <textarea id="textoEvolucao" placeholder="Descreva a evolu√ß√£o..."></textarea>
                    <button onclick="adicionarSessao()">Registrar Sess√£o</button>
                </div>
                <div id="historicoSessoes"></div>
            </div>
        </div>
    </main>
</div>

<div id="modalConfig" class="modal">
    <div class="modal-content">
        <h3>Configurar Anamnese</h3>
        <p>Defina os t√≠tulos dos campos (separados por v√≠rgula):</p>
        <textarea id="configCampos" style="height:100px"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button class="secondary" onclick="fecharConfig()">Cancelar</button>
            <button onclick="salvarConfig()">Salvar</button>
        </div>
    </div>
</div>

<input type="file" id="inputJSON" accept=".json" style="display:none" onchange="processarJSON(this)">
<input type="file" id="inputCSV" accept=".csv" style="display:none" onchange="processarCSV(this)">

<script>
// --- ESTADO GLOBAL ---
let ESTADO = {
    senha: null,
    pacientes: {},
    config: {
        campos: ["Queixa Principal", "Hist√≥rico", "Contexto Familiar", "Avalia√ß√£o Inicial", "Objetivos"]
    },
    pacienteAtual: null
};

const DB_KEY = "PSI_DENY_V3";

// --- CRIPTOGRAFIA ---
function criptografar(texto, senha) {
    if(!texto) return "";
    let res = "";
    for (let i = 0; i < texto.length; i++) res += String.fromCharCode(texto.charCodeAt(i) ^ senha.charCodeAt(i % senha.length));
    return btoa(res);
}
function descriptografar(cifrado, senha) {
    try {
        let texto = atob(cifrado);
        let res = "";
        for (let i = 0; i < texto.length; i++) res += String.fromCharCode(texto.charCodeAt(i) ^ senha.charCodeAt(i % senha.length));
        return res;
    } catch(e) { return null; }
}

// --- PERSIST√äNCIA ---
function salvarNoDisco() {
    if(!ESTADO.senha) return;
    const dados = JSON.stringify({ pacientes: ESTADO.pacientes, config: ESTADO.config });
    localStorage.setItem(DB_KEY, criptografar(dados, ESTADO.senha));
}

function fazerLogin() {
    const pass = document.getElementById('loginPass').value;
    if(!pass) return;
    const raw = localStorage.getItem(DB_KEY);
    
    if (raw) {
        const json = descriptografar(raw, pass);
        if (json) {
            try {
                const dados = JSON.parse(json);
                ESTADO.pacientes = dados.pacientes || {};
                ESTADO.config = dados.config || ESTADO.config;
                ESTADO.senha = pass;
                iniciarApp();
            } catch(e) { alert("Erro ao ler dados."); }
        } else {
            document.getElementById('loginMsg').innerText = "Senha incorreta.";
        }
    } else {
        if(confirm("Criar nova senha mestra?")) {
            ESTADO.senha = pass;
            salvarNoDisco();
            iniciarApp();
        }
    }
}

function logout() { location.reload(); }

function iniciarApp() {
    document.getElementById('loginScreen').style.display = 'none';
    renderLista();
    atualizarCamposDinamicos();
}

// --- CSV PARSER (O SEGREDO DA IMPORTA√á√ÉO) ---
function parseCSVLine(text) {
    let res = [], cur = '', inQuote = false;
    for (let i=0; i<text.length; i++) {
        let c = text[i], n = text[i+1];
        if (c === '"') {
            if (inQuote && n === '"') { cur += '"'; i++; }
            else inQuote = !inQuote;
        } else if (c === ',' && !inQuote) {
            res.push(cur); cur = '';
        } else { cur += c; }
    }
    res.push(cur);
    return res;
}

function processarCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        const headers = parseCSVLine(lines[0]);
        
        let count = 0;
        
        // Mapeamento Inteligente
        let idxNome = headers.findIndex(h => h.includes("Nome Completo"));
        if(idxNome === -1) idxNome = headers.findIndex(h => h.toLowerCase().includes("nome"));
        
        let idxTel = headers.findIndex(h => h.includes("Telefone") || h.includes("Fone"));
        let idxEmail = headers.findIndex(h => h.toLowerCase().includes("e-mail") || h.toLowerCase().includes("email"));
        let idxNasc = headers.findIndex(h => h.match(/\d{4}|nascimento/i) || h.includes("1976")); // Pega a coluna estranha de data

        if (idxNome === -1) return alert("N√£o encontrei a coluna 'Nome Completo' no CSV.");

        for (let i=1; i<lines.length; i++) {
            if(!lines[i].trim()) continue;
            const cols = parseCSVLine(lines[i]);
            const nome = cols[idxNome].trim();
            if(!nome) continue;

            if(!ESTADO.pacientes[nome]) {
                ESTADO.pacientes[nome] = { cadastro: new Date().toISOString(), anamnese: {}, sessoes: [] };
            }

            // Salva dados pessoais
            if(idxTel > -1) ESTADO.pacientes[nome].telefone = cols[idxTel];
            if(idxEmail > -1) ESTADO.pacientes[nome].email = cols[idxEmail];
            if(idxNasc > -1) ESTADO.pacientes[nome].nascimento = cols[idxNasc]; // Formato ISO j√° vem no CSV geralmente

            // Salva o resto na anamnese
            headers.forEach((h, idx) => {
                if([idxNome, idxTel, idxEmail, idxNasc].includes(idx)) return; // Pula os j√° usados
                if(cols[idx]) ESTADO.pacientes[nome].anamnese[h] = cols[idx];
            });
            count++;
        }
        
        salvarNoDisco();
        renderLista();
        alert(`${count} pacientes importados com sucesso!`);
    };
    reader.readAsText(file);
    input.value = "";
}

// --- L√ìGICA DO APP ---
function renderLista() {
    const lista = document.getElementById('listaPacientes');
    const termo = document.getElementById('buscaInput').value.toLowerCase();
    lista.innerHTML = "";
    Object.keys(ESTADO.pacientes).sort().forEach(nome => {
        if(nome.toLowerCase().includes(termo)) {
            const div = document.createElement('div');
            div.className = `patient-item ${ESTADO.pacienteAtual===nome?'active':''}`;
            div.innerHTML = `<strong>${nome}</strong><small>${ESTADO.pacientes[nome].telefone || 'Sem telefone'}</small>`;
            div.onclick = () => abrirPaciente(nome);
            lista.appendChild(div);
        }
    });
}

function filtrarPacientes() { renderLista(); }

function abrirPaciente(nome) {
    ESTADO.pacienteAtual = nome;
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('pacienteView').classList.remove('hidden');
    document.getElementById('tituloPaciente').innerText = nome;
    
    // Preenche dados pessoais
    const p = ESTADO.pacientes[nome];
    document.getElementById('infoTelefone').value = p.telefone || "";
    document.getElementById('infoEmail').value = p.email || "";
    document.getElementById('infoNascimento').value = p.nascimento ? p.nascimento.split("T")[0] : "";

    mudarAba('anamnese');
    renderLista(); // Atualiza sele√ß√£o visual
}

function mudarAba(aba) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#tabAnamnese, #tabSessoes').forEach(d => d.classList.add('hidden'));
    
    if (aba === 'anamnese') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('tabAnamnese').classList.remove('hidden');
        renderAnamnese();
    } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tabSessoes').classList.remove('hidden');
        renderSessoes();
    }
}

function renderAnamnese() {
    const dados = ESTADO.pacientes[ESTADO.pacienteAtual].anamnese || {};
    
    // Campos da Configura√ß√£o
    atualizarCamposDinamicos(); // Reseta os textareas
    document.querySelectorAll('#camposAnamnese textarea').forEach(area => {
        area.value = dados[area.dataset.campo] || "";
    });

    // Campos Extras (Importados)
    const containerExtras = document.getElementById('containerExtras');
    const areaExtras = document.getElementById('camposExtras');
    areaExtras.innerHTML = "";
    
    const chavesConfig = new Set(ESTADO.config.campos);
    const chavesDados = Object.keys(dados);
    let temExtras = false;

    chavesDados.forEach(chave => {
        if (!chavesConfig.has(chave) && dados[chave]) {
            temExtras = true;
            const label = document.createElement('div');
            label.className = "tag-extra";
            label.innerText = chave; // Nome da coluna no CSV

            const input = document.createElement('textarea');
            input.value = dados[chave];
            input.dataset.campoExtra = chave; // Para salvar depois
            input.style.borderColor = "#fed7aa";

            areaExtras.appendChild(label);
            areaExtras.appendChild(input);
        }
    });

    if(temExtras) containerExtras.classList.remove('hidden');
    else containerExtras.classList.add('hidden');
}

function atualizarCamposDinamicos() {
    const container = document.getElementById('camposAnamnese');
    container.innerHTML = "";
    ESTADO.config.campos.forEach(campo => {
        const label = document.createElement('label');
        label.innerText = campo;
        label.style.fontWeight = "600"; label.style.display="block"; label.style.marginTop="10px";
        const area = document.createElement('textarea');
        area.dataset.campo = campo;
        container.appendChild(label);
        container.appendChild(area);
    });
}

function salvarDadosPessoais() {
    if(!ESTADO.pacienteAtual) return;
    const p = ESTADO.pacientes[ESTADO.pacienteAtual];
    p.telefone = document.getElementById('infoTelefone').value;
    p.email = document.getElementById('infoEmail').value;
    p.nascimento = document.getElementById('infoNascimento').value;
    salvarNoDisco();
}

function salvarAnamneseAtual() {
    if(!ESTADO.pacienteAtual) return;
    const novosDados = { ...ESTADO.pacientes[ESTADO.pacienteAtual].anamnese };

    // Salva campos padr√£o
    document.querySelectorAll('#camposAnamnese textarea').forEach(area => {
        novosDados[area.dataset.campo] = area.value;
    });

    // Salva campos extras (caso editados)
    document.querySelectorAll('#camposExtras textarea').forEach(area => {
        novosDados[area.dataset.campoExtra] = area.value;
    });

    ESTADO.pacientes[ESTADO.pacienteAtual].anamnese = novosDados;
    salvarNoDisco();
    alert("Anamnese atualizada! ‚úÖ");
}

function adicionarSessao() {
    const data = document.getElementById('dataSessao').value;
    const texto = document.getElementById('textoEvolucao').value;
    if(!data || !texto) return alert("Preencha data e evolu√ß√£o.");

    ESTADO.pacientes[ESTADO.pacienteAtual].sessoes.push({ data, texto });
    // Ordena
    ESTADO.pacientes[ESTADO.pacienteAtual].sessoes.sort((a,b) => new Date(b.data) - new Date(a.data));
    
    salvarNoDisco();
    document.getElementById('textoEvolucao').value = "";
    renderSessoes();
}

function renderSessoes() {
    const lista = ESTADO.pacientes[ESTADO.pacienteAtual].sessoes || [];
    const div = document.getElementById('historicoSessoes');
    div.innerHTML = "";
    lista.forEach(s => {
        div.innerHTML += `
            <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:15px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">${new Date(s.data).toLocaleDateString('pt-BR')}</div>
                <div style="white-space:pre-wrap;">${s.texto}</div>
            </div>`;
    });
}

function adicionarPaciente() {
    const nome = prompt("Nome do Paciente:");
    if(nome && !ESTADO.pacientes[nome]) {
        ESTADO.pacientes[nome] = { cadastro: new Date().toISOString(), anamnese:{}, sessoes:[] };
        salvarNoDisco();
        renderLista();
        abrirPaciente(nome);
    } else if(ESTADO.pacientes[nome]) alert("Paciente j√° existe.");
}

function excluirPaciente() {
    if(confirm(`Tem certeza que deseja apagar ${ESTADO.pacienteAtual}?`)) {
        delete ESTADO.pacientes[ESTADO.pacienteAtual];
        ESTADO.pacienteAtual = null;
        salvarNoDisco();
        renderLista();
        document.getElementById('pacienteView').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
    }
}

// --- IMPORTAR/EXPORTAR ---
function triggerImport(type) {
    if(type === 'csv') document.getElementById('inputCSV').click();
    else document.getElementById('inputJSON').click();
}
function exportarBackup() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({pacientes: ESTADO.pacientes, config:ESTADO.config}));
    const el = document.createElement('a');
    el.href = dataStr;
    el.download = "Backup_Psi_Deny.json";
    el.click();
}
function processarJSON(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const d = JSON.parse(e.target.result);
            if(d.pacientes) {
                if(confirm("Substituir dados atuais pelo backup?")) {
                    ESTADO.pacientes = d.pacientes;
                    ESTADO.config = d.config || ESTADO.config;
                    salvarNoDisco();
                    logout(); // Relogar para aplicar
                }
            }
        } catch(err) { alert("Arquivo de backup inv√°lido."); }
    };
    reader.readAsText(file);
}

// Configs UI
function abrirConfig() { 
    document.getElementById('configCampos').value = ESTADO.config.campos.join(", ");
    document.getElementById('modalConfig').style.display = 'flex';
}
function fecharConfig() { document.getElementById('modalConfig').style.display = 'none'; }
function salvarConfig() {
    ESTADO.config.campos = document.getElementById('configCampos').value.split(',').map(s=>s.trim()).filter(s=>s);
    salvarNoDisco();
    fecharConfig();
    alert("Configura√ß√£o salva!");
    location.reload();
}

document.getElementById('dataSessao').valueAsDate = new Date();
</script>
</body>
</html>
